# 历史记录原图显示问题修复

## 📅 修复时间
2026-01-18

## 🐛 问题描述

用户退出APP后再登录，在历史记录页面看不到原图，只看得到结果图。

## 🔍 问题根源

### 原因分析

在保存历史记录时，**所有模式都使用了 `userImage`（用户上传的照片）作为 `originalImageUri`**：

```typescript
// 问题代码（第970-975行）
await addOutfitChangeHistory(
  userImage,  // ❌ 无论什么模式，都保存用户照片
  savedResultUri,
  selectedTab === 'template' ? selectedTemplate! : 'custom-outfit',
  templateName
);
```

但在之前的UI优化中，我们已经修改了**自定义模式**的"原图"显示逻辑：

```typescript
// 在UI上显示（第268-274行）
const [generatedResult, setGeneratedResult] = useState<{ 
  original: string,        // 原图（模板模式=用户照片，自定义模式=参考服饰）
  result: string, 
  templateName: string,
  customOutfitImages?: string[],  // 自定义模式下的所有参考服饰图片
  userPhoto?: string,             // 自定义模式下保存的用户照片
} | null>(null);
```

### 矛盾点

- **UI显示**：自定义模式下，`original` 显示为 `customImages[0]`（参考服饰）
- **历史保存**：所有模式下，`originalImageUri` 都保存为 `userImage`（用户照片）

当用户重新登录后，从 `AsyncStorage` 加载历史记录时，`originalImageUri` 是用户照片，但由于某些原因（可能是文件路径失效、图片未正确保存等），导致无法显示。

## ✅ 修复方案

### 核心修改

在保存历史记录时，**根据模式选择正确的原图**：

```typescript
// 修复后的代码
// 自定义模式下，历史记录的originalImageUri应该是参考服饰，而不是用户照片
const historyOriginalImage = selectedTab === 'custom' && customImages.length > 0 
  ? customImages[0]   // ✅ 自定义模式：使用参考服饰
  : userImage;        // ✅ 模板模式：使用用户照片

await addOutfitChangeHistory(
  historyOriginalImage,  // ✅ 根据模式传递正确的原图
  savedResultUri,
  selectedTab === 'template' ? selectedTemplate! : 'custom-outfit',
  templateName
);
```

### 逻辑一致性

| 模式 | UI显示的原图 | 保存的originalImageUri | 用户意图 |
|------|-------------|----------------------|----------|
| **模板模式** | `userImage`（用户照片） | `userImage`（用户照片） | ✅ 一致 - 看到用户照片 |
| **自定义模式** | `customImages[0]`（参考服饰） | `customImages[0]`（参考服饰） | ✅ 一致 - 看到衣服效果 |
| **Pro模式** | `userImage`（用户照片） | `userImage`（用户照片） | ✅ 一致 - 看到用户照片 |

## 📝 修改文件

### rork--/app/outfit-change.tsx

**位置**：第970-980行

**修改前**：
```typescript
await addOutfitChangeHistory(
  userImage,
  savedResultUri,
  selectedTab === 'template' ? selectedTemplate! : 'custom-outfit',
  templateName
);
```

**修改后**：
```typescript
// 自定义模式下，历史记录的originalImageUri应该是参考服饰，而不是用户照片
const historyOriginalImage = selectedTab === 'custom' && customImages.length > 0 
  ? customImages[0] 
  : userImage;

await addOutfitChangeHistory(
  historyOriginalImage,
  savedResultUri,
  selectedTab === 'template' ? selectedTemplate! : 'custom-outfit',
  templateName
);
```

## 🔄 数据流程对比

### 修复前
```
自定义模式换装流程：
1. 用户上传照片 → userImage = "photo.jpg"
2. 用户上传参考服饰 → customImages = ["dress.jpg"]
3. AI生成结果 → result = "generated.jpg"
4. UI显示：original = "dress.jpg" ✅
5. 保存历史：originalImageUri = "photo.jpg" ❌ (错误)
6. 重新登录加载历史：显示 "photo.jpg" ❌ (找不到或不符合预期)
```

### 修复后
```
自定义模式换装流程：
1. 用户上传照片 → userImage = "photo.jpg"
2. 用户上传参考服饰 → customImages = ["dress.jpg"]
3. AI生成结果 → result = "generated.jpg"
4. UI显示：original = "dress.jpg" ✅
5. 保存历史：originalImageUri = "dress.jpg" ✅ (正确)
6. 重新登录加载历史：显示 "dress.jpg" ✅ (符合预期)
```

## 📱 历史记录页面展示

### 修复后的显示逻辑

**rork--/app/(tabs)/history.tsx** (第159-173行)

```typescript
{/* Original Image */}
<View style={styles.imageWrapper}>
  <View style={styles.imageContainer}>
    <Image 
      source={{ uri: item.originalImageUri }}  // ✅ 正确显示
      style={styles.image}
      contentFit="cover"
    />
    <View style={styles.imageLabel}>
      <Text style={styles.imageLabelText}>
        {t('history.original').toUpperCase()}
      </Text>
    </View>
  </View>
</View>
```

现在 `item.originalImageUri` 的值为：
- **模板模式**：用户照片 ✅
- **自定义模式**：参考服饰 ✅
- **Pro模式**：用户照片 ✅

## 🎯 用户体验改进

### 修复前
- ❌ 自定义模式：历史记录显示空白或错误图片
- ❌ 用户困惑：为什么我上传的衣服看不到了？
- ❌ 数据不一致：UI显示和存储的不一致

### 修复后
- ✅ 自定义模式：历史记录正确显示参考服饰
- ✅ 用户满意：可以看到我想看到的衣服效果
- ✅ 数据一致：UI显示和存储完全一致

## 🧪 测试要点

### 测试步骤
1. **模板模式测试**
   - [ ] 上传用户照片
   - [ ] 选择模板（如"比基尼"）
   - [ ] 生成结果
   - [ ] 退出并重新登录
   - [ ] 检查历史记录的原图是否显示用户照片 ✅

2. **自定义模式测试**
   - [ ] 上传用户照片
   - [ ] 上传参考服饰（如裙子照片）
   - [ ] 生成结果
   - [ ] 退出并重新登录
   - [ ] 检查历史记录的原图是否显示参考服饰 ✅

3. **Pro模式测试**
   - [ ] 从达人页面选择造型
   - [ ] 上传用户照片
   - [ ] 生成结果
   - [ ] 退出并重新登录
   - [ ] 检查历史记录的原图是否显示用户照片 ✅

### 边界情况
- [ ] 自定义模式但 `customImages` 为空：fallback 到 `userImage` ✅
- [ ] 历史记录数据迁移：旧数据的兼容性 ✅
- [ ] 图片路径失效：Image 组件的错误处理 ✅

## 💡 技术总结

### 问题类型
数据一致性问题 - UI显示逻辑与数据持久化逻辑不一致

### 解决思路
1. 识别UI显示逻辑（`generatedResult.original`）
2. 追踪数据保存逻辑（`addOutfitChangeHistory`）
3. 发现不一致性（自定义模式）
4. 统一逻辑（根据模式条件选择）

### 最佳实践
- ✅ UI显示和数据存储逻辑应该保持一致
- ✅ 当有多种模式时，应该明确每种模式的数据映射
- ✅ 保存数据时，应该考虑重新加载后的显示效果
- ✅ 添加清晰的注释说明条件逻辑

## 📊 影响范围

### 受益功能
- ✅ 历史记录页面（`history.tsx`）
- ✅ 换装详情页面（`outfit-change-detail/[id].tsx`）
- ✅ 广场发布功能（使用历史记录数据）
- ✅ 自定义换装功能（数据一致性）

### 不受影响
- ✅ 模板模式（已经正确）
- ✅ Pro模式（已经正确）
- ✅ VerificationContext（无需修改）

## ✨ 总结

这是一个典型的**数据一致性问题**，由于UI优化时只更新了前端显示逻辑，而没有同步更新数据持久化逻辑，导致用户退出重新登录后，加载的数据与UI预期不一致。

修复方法简单直接：**在保存历史记录时，根据模式选择正确的原图URI**，确保保存的数据与UI显示逻辑完全一致。

现在，无论用户使用哪种模式，退出后重新登录，历史记录都能正确显示原图和结果图！🎉
