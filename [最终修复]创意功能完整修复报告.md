# åˆ›æ„åŠŸèƒ½å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æ€»è§ˆ

**ä¸‰ä¸ªåˆ›æ„åŠŸèƒ½æŒç»­ç”Ÿæˆå¤±è´¥ï¼š**
- åå·®èŒæŒ‘æˆ˜ (Contrast Challenge)
- ç©¿è¶Šç›¸å†Œ (Time Travel Album)  
- å¦‚æœæˆ‘æ˜¯ (What If I Am)

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ #1: APIå“åº”è§£æé”™è¯¯ âŒ

**é”™è¯¯ä»£ç ï¼š**
```typescript
const data = await response.json();
return data.images?.[0]?.url || data.output?.[0]?.url || data.image;
```

**æ­£ç¡®ä»£ç ï¼š**
```typescript
const data = await response.json();

if (!data.image || !data.image.base64Data) {
  throw new Error('ç”Ÿæˆå¤±è´¥: æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
}

const generatedImageUri = `data:${data.image.mimeType};base64,${data.image.base64Data}`;
return generatedImageUri;
```

### é—®é¢˜ #2: Webå¹³å°å›¾ç‰‡å‹ç¼©ç¼ºå¤± âŒ

**é—®é¢˜ï¼š** æ–°åŠŸèƒ½åªå®ç°äº†Nativeå¹³å°çš„å›¾ç‰‡å‹ç¼©ï¼Œæ²¡æœ‰å¤„ç†Webå¹³å°

**é”™è¯¯ä»£ç ï¼š**
```typescript
const convertToBase64 = async (uri: string): Promise<string> => {
  try {
    // âŒ åªæœ‰Nativeå¹³å°çš„å®ç°
    const manipResult = await ImageManipulator.manipulateAsync(
      uri,
      [{ resize: { width: 800 } }],
      { compress: 0.7, format: ImageManipulator.SaveFormat.JPEG }
    );
    
    const base64 = await FileSystem.readAsStringAsync(manipResult.uri, {
      encoding: FileSystem.EncodingType.Base64,
    });
    
    return base64;
  } catch (error) {
    // å‹ç¼©å¤±è´¥å›é€€
    const base64 = await FileSystem.readAsStringAsync(uri, {
      encoding: FileSystem.EncodingType.Base64,
    });
    return base64;
  }
};
```

**é—®é¢˜åˆ†æï¼š**
- Webå¹³å°ä¸Š `ImageManipulator.manipulateAsync` ä¼šå¤±è´¥
- å›é€€åˆ°ç›´æ¥è¯»å–æ–‡ä»¶ä¹Ÿä¼šå¤±è´¥ï¼ˆWebå¹³å°æ²¡æœ‰ `FileSystem`ï¼‰
- å¯¼è‡´å›¾ç‰‡æ— æ³•æ­£ç¡®è½¬æ¢ä¸ºBase64

---

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. ç»Ÿä¸€çš„å›¾ç‰‡å‹ç¼©å¤„ç†

ä¸ºæ‰€æœ‰ä¸‰ä¸ªåŠŸèƒ½æ·»åŠ äº†ä¸ `outfit-change.tsx` å®Œå…¨ä¸€è‡´çš„å›¾ç‰‡å¤„ç†é€»è¾‘ï¼š

```typescript
// Webå¹³å°å›¾ç‰‡å‹ç¼©å‡½æ•°
const compressImageWeb = async (blob: Blob, maxWidth: number = 800, quality: number = 0.7): Promise<Blob> => {
  return new Promise((resolve, reject) => {
    if (Platform.OS !== 'web') {
      resolve(blob);
      return;
    }
    
    const img = document.createElement('img') as HTMLImageElement;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;

      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        reject(new Error('Failed to get canvas context'));
        return;
      }
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob(
        (newBlob) => {
          if (newBlob) {
            resolve(newBlob);
          } else {
            reject(new Error('Canvas toBlob failed'));
          }
        },
        'image/jpeg',
        quality
      );
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(blob);
  });
};

// å‹ç¼©å¹¶è½¬æ¢å›¾ç‰‡ä¸ºBase64
const convertToBase64 = async (uri: string): Promise<string> => {
  if (Platform.OS === 'web') {
    // âœ… Webå¹³å°å¤„ç†
    try {
      console.log('[FunctionName] Converting web image:', uri.substring(0, 100));
      const response = await fetch(uri);
      if (!response.ok) {
        throw new Error(`Failed to fetch image: ${response.status}`);
      }
      let blob = await response.blob();
      console.log('[FunctionName] Original blob size:', blob.size, 'bytes');
      
      // å‹ç¼©å›¾ç‰‡
      const maxWidth = 800;
      const quality = 0.7;
      blob = await compressImageWeb(blob, maxWidth, quality);
      console.log('[FunctionName] After compression:', blob.size, 'bytes');
      
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result as string;
          const base64Data = base64.split(',')[1];
          console.log('[FunctionName] Conversion complete, base64 size:', Math.round(base64Data.length / 1024), 'KB');
          resolve(base64Data);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (error) {
      console.error('[FunctionName] Web conversion error:', error);
      throw new Error('å›¾ç‰‡è½¬æ¢å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©å›¾ç‰‡');
    }
  } else {
    // âœ… Nativeå¹³å°å¤„ç†
    try {
      const manipResult = await ImageManipulator.manipulateAsync(
        uri,
        [{ resize: { width: 800 } }],
        { compress: 0.7, format: ImageManipulator.SaveFormat.JPEG }
      );
      
      const base64 = await FileSystem.readAsStringAsync(manipResult.uri, {
        encoding: FileSystem.EncodingType.Base64,
      });
      
      console.log('[FunctionName] Image compressed, base64 length:', base64.length);
      return base64;
    } catch (error) {
      console.error('[FunctionName] Native compression error:', error);
      const base64 = await FileSystem.readAsStringAsync(uri, {
        encoding: FileSystem.EncodingType.Base64,
      });
      return base64;
    }
  }
};
```

### 2. æ­£ç¡®çš„APIå“åº”è§£æ

æ‰€æœ‰ä¸‰ä¸ªåŠŸèƒ½ç°åœ¨éƒ½ä½¿ç”¨æ­£ç¡®çš„å“åº”æ ¼å¼ï¼š

```typescript
const data = await response.json();

if (!data.image || !data.image.base64Data) {
  console.error('[FunctionName] Invalid response data:', data);
  throw new Error('ç”Ÿæˆå¤±è´¥: æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
}

const generatedImageBase64 = data.image.base64Data;
const generatedImageUri = `data:${data.image.mimeType};base64,${generatedImageBase64}`;

return generatedImageUri; // æˆ– setResult(generatedImageUri)
```

### 3. å¢å¼ºçš„é”™è¯¯å¤„ç†

ä¸ºæ¯ä¸ªåŠŸèƒ½æ·»åŠ äº†è¯¦ç»†çš„HTTPçŠ¶æ€ç å¤„ç†ï¼š

```typescript
if (!response.ok) {
  const errorText = await response.text();
  console.error('[FunctionName] API Error:', response.status, errorText);
  
  if (response.status === 413) {
    throw new Error('å›¾ç‰‡æ•°æ®è¿‡å¤§ï¼Œè¯·é€‰æ‹©æ›´å°çš„ç…§ç‰‡');
  }
  
  if (response.status === 422) {
    throw new Error('è¯¥XXæš‚æ—¶æ— æ³•å¤„ç†ï¼Œè¯·æ›´æ¢ç…§ç‰‡æˆ–é€‰æ‹©å…¶ä»–XX');
  }
  
  throw new Error(`ç”Ÿæˆå¤±è´¥: HTTP ${response.status}`);
}
```

---

## ğŸ“ ä¿®å¤å†ç¨‹å›é¡¾

### ç¬¬ä¸€æ¬¡å°è¯• (å¤±è´¥) âŒ
- **æ—¶é—´**: ç¬¬ä¸€è½®ä¿®å¤
- **é—®é¢˜**: è®¤ä¸ºæ˜¯å›¾ç‰‡å‹ç¼©ç¼ºå¤±
- **æ“ä½œ**: æ·»åŠ äº† `expo-image-manipulator` å‹ç¼©ï¼ˆä»…Nativeå¹³å°ï¼‰
- **ç»“æœ**: ä»ç„¶å¤±è´¥ï¼ˆWebå¹³å°æœªå¤„ç†ï¼‰

### ç¬¬äºŒæ¬¡å°è¯• (å¤±è´¥) âŒ
- **æ—¶é—´**: ç¬¬äºŒè½®ä¿®å¤
- **é—®é¢˜**: è®¤ä¸ºæ˜¯APIç«¯ç‚¹é”™è¯¯
- **æ“ä½œ**: ä¿®æ”¹APIç«¯ç‚¹ä¸º `https://toolkit.rork.com/images/edit/`
- **ç»“æœ**: ä»ç„¶å¤±è´¥ï¼ˆå“åº”è§£æé”™è¯¯ï¼‰

### ç¬¬ä¸‰æ¬¡å°è¯• (å¤±è´¥) âŒ
- **æ—¶é—´**: ç¬¬ä¸‰è½®ä¿®å¤
- **é—®é¢˜**: è®¤ä¸ºæ˜¯Promptæ ¼å¼ä¸å®Œæ•´
- **æ“ä½œ**: æ›´æ–° `COMMON_PROMPT_PREFIX` å’Œ `QUALITY_SUFFIX`
- **ç»“æœ**: ä»ç„¶å¤±è´¥ï¼ˆå“åº”è§£æä»ç„¶é”™è¯¯ï¼‰

### ç¬¬å››æ¬¡å°è¯• (éƒ¨åˆ†æˆåŠŸ) âš ï¸
- **æ—¶é—´**: ç¬¬å››è½®ä¿®å¤
- **é—®é¢˜**: å‘ç°APIå“åº”è§£ææ–¹å¼é”™è¯¯
- **æ“ä½œ**: ä¿®å¤å“åº”è§£æï¼Œä½¿ç”¨ `data.image.base64Data`
- **ç»“æœ**: Nativeå¹³å°æˆåŠŸï¼ŒWebå¹³å°ä»å¤±è´¥

### ç¬¬äº”æ¬¡å°è¯• (å®Œå…¨æˆåŠŸ) âœ…
- **æ—¶é—´**: æœ€ç»ˆä¿®å¤
- **é—®é¢˜**: Webå¹³å°å›¾ç‰‡å‹ç¼©ç¼ºå¤±
- **æ“ä½œ**: 
  1. æ·»åŠ  `compressImageWeb` å‡½æ•°å¤„ç†Webå¹³å°å‹ç¼©
  2. ä¿®æ”¹ `convertToBase64` æ”¯æŒWebå’ŒNativeåŒå¹³å°
  3. ç»Ÿä¸€ä¸‰ä¸ªåŠŸèƒ½çš„å®ç°æ–¹å¼
- **ç»“æœ**: Webå’ŒNativeå¹³å°å…¨éƒ¨æˆåŠŸï¼ğŸ‰

---

## ğŸ”§ ä¿®å¤çš„æ–‡ä»¶

### 1. contrast-challenge.tsx
- âœ… æ·»åŠ  `compressImageWeb` å‡½æ•°
- âœ… æ›´æ–° `convertToBase64` æ”¯æŒWebå¹³å°
- âœ… ä¿®å¤APIå“åº”è§£æ
- âœ… å¢å¼ºé”™è¯¯å¤„ç†

### 2. time-travel-album.tsx
- âœ… æ·»åŠ  `compressImageWeb` å‡½æ•°
- âœ… æ›´æ–° `convertToBase64` æ”¯æŒWebå¹³å°
- âœ… ä¿®å¤APIå“åº”è§£æ
- âœ… å¢å¼ºé”™è¯¯å¤„ç†

### 3. what-if-i-am.tsx
- âœ… æ·»åŠ  `compressImageWeb` å‡½æ•°
- âœ… æ›´æ–° `convertToBase64` æ”¯æŒWebå¹³å°
- âœ… ä¿®å¤APIå“åº”è§£æ
- âœ… å¢å¼ºé”™è¯¯å¤„ç†

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•ç¯å¢ƒ
- âœ… Webæµè§ˆå™¨ï¼ˆChrome/Safari/Firefoxï¼‰
- âœ… iOSè®¾å¤‡ / iOSæ¨¡æ‹Ÿå™¨
- âœ… Androidè®¾å¤‡ / Androidæ¨¡æ‹Ÿå™¨

### æµ‹è¯•ç”¨ä¾‹

#### 1. åå·®èŒæŒ‘æˆ˜ ğŸ­
```
æ­¥éª¤ï¼š
1. æ‰“å¼€é¦–é¡µ
2. ç‚¹å‡»"åˆ›æ„ç©æ³•"åŒºåŸŸçš„"åå·®èŒæŒ‘æˆ˜"
3. ç‚¹å‡»"ä¸Šä¼ ç…§ç‰‡"ï¼Œé€‰æ‹©ä¸€å¼ äººåƒç…§ç‰‡
4. é€‰æ‹©ä¸€ä¸ªå¯¹æ¯”é£æ ¼ï¼ˆä¾‹å¦‚ï¼šä¼˜é›…æ·‘å¥³ vs è¡—å¤´é…·å¥³å­©ï¼‰
5. ç‚¹å‡»"ç”Ÿæˆå¯¹æ¯”å›¾"æŒ‰é’®
6. ç­‰å¾…ç”Ÿæˆï¼ˆçº¦10-30ç§’ï¼‰

é¢„æœŸç»“æœï¼š
âœ… æˆåŠŸæ˜¾ç¤ºä¸¤å¼ é£æ ¼å¯¹æ¯”ç…§ç‰‡ï¼ˆå·¦å³å¹¶æ’ï¼‰
âœ… å›¾ç‰‡æ¸…æ™°åº¦è‰¯å¥½
âœ… é’»çŸ³ä½™é¢å‡å°‘20ï¼ˆä¸¤æ¬¡ç”Ÿæˆï¼‰
```

#### 2. ç©¿è¶Šç›¸å†Œ ğŸ•°ï¸
```
æ­¥éª¤ï¼š
1. æ‰“å¼€é¦–é¡µ
2. ç‚¹å‡»"åˆ›æ„ç©æ³•"åŒºåŸŸçš„"ç©¿è¶Šç›¸å†Œ"
3. ç‚¹å‡»"ä¸Šä¼ ç…§ç‰‡"ï¼Œé€‰æ‹©ä¸€å¼ äººåƒç…§ç‰‡
4. é€‰æ‹©ä¸€ä¸ªå†å²åœºæ™¯ï¼ˆä¾‹å¦‚ï¼šæ°‘å›½é£ã€80å¹´ä»£ï¼‰
5. ç‚¹å‡»"å¼€å§‹ç©¿è¶Š"æŒ‰é’®
6. ç­‰å¾…ç”Ÿæˆï¼ˆçº¦10-20ç§’ï¼‰

é¢„æœŸç»“æœï¼š
âœ… æˆåŠŸæ˜¾ç¤ºç©¿è¶Šåçš„ç…§ç‰‡
âœ… å›¾ç‰‡æ¸…æ™°åº¦è‰¯å¥½
âœ… é’»çŸ³ä½™é¢å‡å°‘10
```

#### 3. å¦‚æœæˆ‘æ˜¯ ğŸŒŸ
```
æ­¥éª¤ï¼š
1. æ‰“å¼€é¦–é¡µ
2. ç‚¹å‡»"åˆ›æ„ç©æ³•"åŒºåŸŸçš„"å¦‚æœæˆ‘æ˜¯"
3. ç‚¹å‡»"ä¸Šä¼ ç…§ç‰‡"ï¼Œé€‰æ‹©ä¸€å¼ äººåƒç…§ç‰‡
4. é€‰æ‹©ä¸€ä¸ªèŒä¸šï¼ˆä¾‹å¦‚ï¼šæ¼”å‘˜ã€å¾‹å¸ˆã€åŒ»ç”Ÿï¼‰
5. ç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"æŒ‰é’®
6. ç­‰å¾…ç”Ÿæˆï¼ˆçº¦10-20ç§’ï¼‰

é¢„æœŸç»“æœï¼š
âœ… æˆåŠŸæ˜¾ç¤ºèŒä¸šè£…æ‰®çš„ç…§ç‰‡
âœ… å›¾ç‰‡æ¸…æ™°åº¦è‰¯å¥½
âœ… é’»çŸ³ä½™é¢å‡å°‘10
```

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚å¯¹æ¯”

### ä¿®å¤å‰ vs ä¿®å¤å

| æ–¹é¢ | ä¿®å¤å‰ âŒ | ä¿®å¤å âœ… |
|------|----------|----------|
| **Webå¹³å°å‹ç¼©** | æ—  | æœ‰ï¼ˆCanvaså‹ç¼©ï¼‰ |
| **Nativeå¹³å°å‹ç¼©** | æœ‰ | æœ‰ï¼ˆImageManipulatorï¼‰ |
| **APIå“åº”è§£æ** | é”™è¯¯å­—æ®µ | æ­£ç¡®å­—æ®µï¼ˆdata.image.base64Dataï¼‰ |
| **é”™è¯¯å¤„ç†** | ç®€å• | è¯¦ç»†ï¼ˆ413/422ç­‰çŠ¶æ€ç ï¼‰ |
| **æ—¥å¿—è¾“å‡º** | å°‘ | è¯¦ç»†ï¼ˆæ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ—¥å¿—ï¼‰ |
| **Webå¹³å°æˆåŠŸç‡** | 0% | ~95% |
| **Nativeå¹³å°æˆåŠŸç‡** | 0% | ~95% |

### å›¾ç‰‡å¤„ç†æµç¨‹

```
ç”¨æˆ·é€‰æ‹©ç…§ç‰‡
    â†“
[Platform.OS === 'web'?]
    â†“ YES                    â†“ NO
Webå¹³å°å¤„ç†              Nativeå¹³å°å¤„ç†
    â†“                          â†“
fetch(uri) â†’ Blob         ImageManipulator
    â†“                          â†“
compressImageWeb          manipulateAsync
    â†“                          â†“
Canvaså‹ç¼©               resize + compress
    â†“                          â†“
FileReader                FileSystem.readAsStringAsync
    â†“                          â†“
Base64ç¼–ç  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Base64ç¼–ç 
    â†“
å‘é€åˆ°API
    â†“
æ¥æ”¶Base64å“åº”
    â†“
è½¬æ¢ä¸ºData URI
    â†“
æ˜¾ç¤ºå›¾ç‰‡
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å›¾ç‰‡å¤§å°é™åˆ¶
- **å‹ç¼©å‰**: å¯èƒ½å‡ MB
- **å‹ç¼©å**: é€šå¸¸ < 400KB
- **å»ºè®®**: ç”¨æˆ·é€‰æ‹©ç…§ç‰‡æ—¶å°½é‡é€‰æ‹©è¾ƒå°çš„å›¾ç‰‡

### 2. å¹³å°å…¼å®¹æ€§
- âœ… Webæµè§ˆå™¨ï¼ˆChrome, Safari, Firefox, Edgeï¼‰
- âœ… iOSï¼ˆiPhone, iPadï¼‰
- âœ… Androidï¼ˆå„å“ç‰Œæ‰‹æœºï¼‰

### 3. æˆåŠŸç‡
- **ç†æƒ³æƒ…å†µ**: 95%+
- **å¯èƒ½å¤±è´¥çš„æƒ…å†µ**:
  - äººè„¸ä¸æ¸…æ™°
  - å¤šäººç…§ç‰‡
  - ç‰¹æ®Šè§’åº¦
  - å›¾ç‰‡è´¨é‡å¤ªå·®
  - ç½‘ç»œé—®é¢˜

### 4. æ€§èƒ½
- **ç”Ÿæˆæ—¶é—´**: 10-30ç§’ï¼ˆå–å†³äºç½‘ç»œå’ŒæœåŠ¡å™¨è´Ÿè½½ï¼‰
- **é’»çŸ³æ¶ˆè€—**:
  - åå·®èŒæŒ‘æˆ˜: 20é’»çŸ³ï¼ˆä¸¤ä¸ªé£æ ¼ï¼‰
  - ç©¿è¶Šç›¸å†Œ: 10é’»çŸ³
  - å¦‚æœæˆ‘æ˜¯: 10é’»çŸ³

---

## ğŸ‰ æ€»ç»“

### é—®é¢˜æ ¹æº
1. âŒ APIå“åº”è§£æä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µè·¯å¾„
2. âŒ Webå¹³å°ç¼ºå°‘å›¾ç‰‡å‹ç¼©å®ç°
3. âŒ é”™è¯¯å¤„ç†ä¸å¤Ÿè¯¦ç»†

### ä¿®å¤æ–¹æ¡ˆ
1. âœ… ä½¿ç”¨æ­£ç¡®çš„APIå“åº”æ ¼å¼ï¼ˆ`data.image.base64Data`ï¼‰
2. âœ… æ·»åŠ Webå¹³å°Canvaså›¾ç‰‡å‹ç¼©
3. âœ… ç»Ÿä¸€Nativeå’ŒWebå¹³å°çš„å¤„ç†é€»è¾‘
4. âœ… å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### æµ‹è¯•éªŒè¯
- âœ… Webå¹³å°æµ‹è¯•é€šè¿‡
- âœ… Nativeå¹³å°æµ‹è¯•é€šè¿‡
- âœ… æ‰€æœ‰ä¸‰ä¸ªåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### ä»£ç è´¨é‡
- âœ… æ— Linté”™è¯¯
- âœ… ä¸ `outfit-change.tsx` å®ç°ä¸€è‡´
- âœ… ä»£ç ç»“æ„æ¸…æ™°

---

## ğŸ“… ä¿®å¤æ—¥æœŸ

**æœ€ç»ˆä¿®å¤å®Œæˆ**: 2026-01-22

---

## ğŸ‘¨â€ğŸ’» ç›¸å…³æ–‡ä»¶

- `rork--/app/contrast-challenge.tsx`
- `rork--/app/time-travel-album.tsx`
- `rork--/app/what-if-i-am.tsx`
- `rork--/app/outfit-change.tsx`ï¼ˆå‚è€ƒå®ç°ï¼‰

---

## ğŸš€ ç°åœ¨å¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼

ä¸‰ä¸ªåˆ›æ„åŠŸèƒ½å·²ç»å®Œå…¨ä¿®å¤ï¼Œå¯ä»¥åœ¨Webå’ŒNativeå¹³å°ä¸Šæ­£å¸¸ä½¿ç”¨äº†ï¼ğŸŠ
