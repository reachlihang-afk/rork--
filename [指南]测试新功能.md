# 测试新功能指南 🧪

**版本**: v2.0 - 免费额度系统  
**测试日期**: 2026-01-22  
**预计测试时间**: 15-30分钟

---

## 🎯 测试目标

验证第一阶段核心功能：
1. ✅ 免费额度系统（每日10次）
2. ✅ 奖励机制（新用户50次）
3. ✅ UI显示（免费次数徽章）
4. ✅ 数据埋点（控制台日志）

---

## 🚀 快速开始

### 启动应用

```bash
# 进入项目目录
cd rork--

# 启动开发服务器
npm start

# 或使用已有的启动脚本
start-expo.bat
```

### 打开浏览器
```
访问：http://localhost:8081
或扫描二维码在手机上测试
```

---

## 📝 测试清单

### 测试1：新用户注册奖励 🎁

**步骤**：
1. 打开应用
2. 点击"个人中心"（Profile）
3. 如果已登录，先退出登录
4. 使用新手机号注册登录
5. 进入"一键换装"页面

**预期结果**：
```
✅ Header显示：🎁 50/50 （新用户奖励）
✅ 控制台输出：
   [CoinContext] Bonus quota set: { newUserBonus: 50, ... }
```

**验证要点**：
- 免费次数显示为50（不是10）
- 可以连续生成50次而不消耗钻石

---

### 测试2：每日免费额度 ⭐

**步骤**：
1. 使用已注册用户登录
2. 进入"一键换装"页面
3. 查看Header右上角

**预期结果**：
```
✅ 显示：🎁 X/10 或 🎁 X/60（如果有奖励）
   其中X是剩余次数
✅ 免费徽章：淡绿色背景 + 深绿色文字
✅ 钻石徽章：灰色背景
```

**验证要点**：
- 两个徽章并排显示
- 免费次数在左，钻石在右
- 样式美观，间距合理

---

### 测试3：免费生成功能 🎨

**步骤**：
1. 上传一张人像照片
2. 选择一个模板（例如：优雅淑女）
3. 点击"开始生成"按钮
4. 等待生成完成

**预期结果**：
```
✅ 生成开始时，控制台输出：
   [Analytics] Event: {
     event: 'generation_start',
     properties: {
       useFreeQuota: true,
       remainingFreeQuota: 9
     }
   }

✅ 生成成功后：
   - 图片正常显示
   - Header免费次数减1（例如：🎁 9/10）
   - 控制台输出：
     [Analytics] Event: generation_success
     [CoinContext] Free quota used, remaining: 9
```

**验证要点**：
- 免费次数正确递减
- 钻石余额不变
- 生成速度正常
- 埋点正确触发

---

### 测试4：用尽免费次数 ⚠️

**步骤**：
1. 连续生成直到免费次数用完
2. 再次尝试生成

**预期结果**：
```
✅ 弹窗显示：
   "免费次数已用完！观看广告可获得5次额外机会"
   
✅ 三个按钮：
   [取消] [观看广告 📺] [充值]
   
✅ 控制台输出：
   [Analytics] Event: free_quota_depleted
   {
     totalUsed: 10,
     dailyBase: 10,
     bonusUsed: 0,
     showAdPrompt: true
   }
```

**验证要点**：
- 弹窗文案正确
- 按钮功能正常
- 埋点触发

**注意**: 观看广告功能会显示"即将上线"提示（因AdMob SDK未集成）

---

### 测试5：钻石付费生成 💎

**步骤**：
1. 在免费次数用完后
2. 确保有钻石余额（>=10）
3. 点击"充值"按钮
4. 返回生成页面
5. 再次生成

**预期结果**：
```
✅ 生成开始时：
   - 消耗10💎（从原来的100降低）
   - 控制台输出：useFreeQuota: false
   
✅ 生成成功后：
   - 钻石余额减10
   - 免费次数不变（仍为0）
```

**验证要点**：
- 钻石正确扣除
- 免费次数和钻石分开计算

---

### 测试6：数据埋点验证 📊

**步骤**：
1. 打开浏览器开发者工具（F12）
2. 切换到Console标签
3. 执行各种操作（生成、分享、点赞等）

**预期输出示例**：
```javascript
// 生成开始
[Analytics] Event: {
  event: 'generation_start',
  properties: {
    styleId: 'elegant-lady',
    styleName: '优雅淑女',
    mainTab: 'outfit',
    useFreeQuota: true,
    remainingFreeQuota: 9,
    userId: 'user_123',
    sessionId: 'session_xxx',
    timestamp: 1737547200000,
    platform: 'web'
  }
}

// 生成成功
[Analytics] Event: {
  event: 'generation_success',
  properties: {
    styleId: 'elegant-lady',
    duration: 15234,  // 毫秒
    usedFreeQuota: true,
    remainingFreeQuota: 8
  }
}

// 生成失败
[Analytics] Event: {
  event: 'generation_fail',
  properties: {
    error: '网络连接失败',
    errorCode: 'network_error'
  }
}
```

**验证要点**：
- 所有关键操作都有埋点
- 事件属性完整
- 时间戳正确
- 用户ID正确

---

### 测试7：每日重置逻辑 🔄

**方法1：修改系统日期**（推荐）
```javascript
// 在浏览器Console中执行
// 1. 获取当前storage key
const userId = 'YOUR_USER_ID';
const usageKey = `daily_usage_${userId}`;

// 2. 读取当前数据
const data = await AsyncStorage.getItem(usageKey);
console.log('Current usage:', data);

// 3. 修改日期为昨天
const usage = JSON.parse(data);
usage.date = '2026-01-21';  // 昨天
await AsyncStorage.setItem(usageKey, JSON.stringify(usage));

// 4. 刷新页面
location.reload();
```

**预期结果**：
```
✅ 页面刷新后：
   - 免费次数重置为10
   - 已使用次数清零
   - 控制台输出：
     [CoinContext] Daily usage reset
```

**方法2：等待第二天**（自然测试）
```
明天打开应用验证：
✅ 免费次数自动恢复到10
✅ 分享次数重置（0/3）
✅ 广告次数重置（0/6）
```

---

### 测试8：多种奖励累加 🎁

**模拟步骤**（需要手动修改数据）：

```javascript
// 在浏览器Console中
const userId = 'YOUR_USER_ID';
const bonusKey = `bonus_quota_${userId}`;

// 设置多种奖励
const bonus = {
  newUserBonus: 20,    // 新用户还剩20次
  inviteBonus: 60,     // 邀请3个好友（3×20）
  signInBonus: 30,     // 签到奖励
  signInStreak: 7,     // 连续7天
  adRewardQuota: 15    // 观看3次广告（3×5）
};

await AsyncStorage.setItem(bonusKey, JSON.stringify(bonus));
location.reload();
```

**预期结果**：
```
✅ Header显示：🎁 125/135
   计算：10（每日）+ 20 + 60 + 30 + 15 = 135
   
✅ 可以连续生成125次
   
✅ 使用优先级：
   1. newUserBonus
   2. adRewardQuota
   3. signInBonus
   4. inviteBonus
   5. 每日基础
```

---

## 🐛 常见问题排查

### 问题1：免费次数不显示

**可能原因**：
- 用户未登录
- AsyncStorage数据损坏

**解决方案**：
```javascript
// 清除缓存
await AsyncStorage.clear();
location.reload();
// 重新登录
```

---

### 问题2：免费次数没有递减

**检查**：
```javascript
// 查看控制台
// 应该看到：
[CoinContext] Free quota used
[CoinContext] New quota: { remaining: 9 }

// 如果没看到，检查：
1. useOutfitChange() 是否被调用
2. saveData() 是否正常执行
```

---

### 问题3：埋点没有输出

**检查**：
```javascript
// 1. 确认import
import { trackEvent } from '@/utils/analytics';

// 2. 确认调用
trackEvent('generation_start', {...});

// 3. 查看analytics.ts中的setEnabled
analytics.setEnabled(true);  // 确保已启用
```

---

### 问题4：新用户没有50次奖励

**检查**：
```javascript
// 1. 查看bonusQuota
const userId = 'USER_ID';
const bonusKey = `bonus_quota_${userId}`;
const data = await AsyncStorage.getItem(bonusKey);
console.log('Bonus:', JSON.parse(data));

// 2. 应该看到
{ newUserBonus: 50, ... }

// 3. 如果不是，手动设置
const bonus = {
  newUserBonus: 50,
  inviteBonus: 0,
  signInStreak: 1,
  signInBonus: 0,
  adRewardQuota: 0
};
await AsyncStorage.setItem(bonusKey, JSON.stringify(bonus));
```

---

## 📊 测试数据记录表

请在测试时填写以下表格：

| 测试项 | 状态 | 问题描述 | 截图/日志 |
|--------|------|----------|-----------|
| 新用户奖励 | ☐ 通过 ☐ 失败 |  |  |
| 每日免费额度 | ☐ 通过 ☐ 失败 |  |  |
| 免费生成 | ☐ 通过 ☐ 失败 |  |  |
| 用尽提示 | ☐ 通过 ☐ 失败 |  |  |
| 钻石付费 | ☐ 通过 ☐ 失败 |  |  |
| 数据埋点 | ☐ 通过 ☐ 失败 |  |  |
| 每日重置 | ☐ 通过 ☐ 失败 |  |  |
| 奖励累加 | ☐ 通过 ☐ 失败 |  |  |

---

## 🎯 测试完成标准

**基础功能（必须全部通过）**：
- ✅ 免费次数正确显示
- ✅ 免费次数正确递减
- ✅ 用尽时正确提示
- ✅ 钻石付费正常工作

**高级功能（至少通过3项）**：
- ✅ 新用户奖励发放
- ✅ 每日重置正确
- ✅ 埋点正常输出
- ✅ 奖励累加正确

**用户体验（主观评价）**：
- ☐ UI美观度：1-5分 _____
- ☐ 交互流畅度：1-5分 _____
- ☐ 提示清晰度：1-5分 _____
- ☐ 整体满意度：1-5分 _____

---

## 📸 测试截图指南

**必须截图的界面**：

1. **Header显示**
   - 免费次数徽章
   - 钻石余额徽章
   - 两者并排显示

2. **用尽提示弹窗**
   - 弹窗文案
   - 三个按钮

3. **控制台埋点**
   - generation_start事件
   - generation_success事件
   - free_quota_depleted事件

4. **新用户奖励**
   - 显示50/50的截图

---

## 🔧 调试技巧

### 查看所有Storage数据
```javascript
// 在浏览器Console执行
const getAllKeys = async () => {
  const keys = await AsyncStorage.getAllKeys();
  const items = await AsyncStorage.multiGet(keys);
  console.table(items.map(([key, value]) => ({
    key,
    value: value?.substring(0, 100)
  })));
};
getAllKeys();
```

### 重置用户数据
```javascript
// 完全清除当前用户数据
const resetUser = async () => {
  const userId = 'YOUR_USER_ID';
  await AsyncStorage.removeItem(`user_coins_${userId}`);
  await AsyncStorage.removeItem(`daily_usage_${userId}`);
  await AsyncStorage.removeItem(`bonus_quota_${userId}`);
  location.reload();
};
resetUser();
```

### 模拟不同场景
```javascript
// 场景1：新用户（50次）
const setNewUser = async (userId) => {
  await AsyncStorage.setItem(`bonus_quota_${userId}`, JSON.stringify({
    newUserBonus: 50,
    inviteBonus: 0,
    signInStreak: 1,
    signInBonus: 0,
    adRewardQuota: 0
  }));
  location.reload();
};

// 场景2：活跃用户（累积奖励）
const setActiveUser = async (userId) => {
  await AsyncStorage.setItem(`bonus_quota_${userId}`, JSON.stringify({
    newUserBonus: 0,
    inviteBonus: 40,      // 邀请2个好友
    signInStreak: 15,
    signInBonus: 60,      // 签到两轮
    adRewardQuota: 25     // 观看5次广告
  }));
  location.reload();
};

// 场景3：用尽免费（测试付费）
const setDepletedUser = async (userId) => {
  await AsyncStorage.setItem(`daily_usage_${userId}`, JSON.stringify({
    date: '2026-01-22',
    outfitChangeCount: 10,  // 用完
    shareCount: 3,          // 分享上限
    adWatchCount: 6         // 广告上限
  }));
  await AsyncStorage.setItem(`bonus_quota_${userId}`, JSON.stringify({
    newUserBonus: 0,
    inviteBonus: 0,
    signInStreak: 1,
    signInBonus: 0,
    adRewardQuota: 0
  }));
  await AsyncStorage.setItem(`user_coins_${userId}`, JSON.stringify(100)); // 100钻石
  location.reload();
};
```

---

## ✅ 测试通过后

**确认清单**：
- ☐ 所有基础功能正常
- ☐ 至少3项高级功能正常
- ☐ 用户体验满意度 >= 4分
- ☐ 已截图保存测试证据
- ☐ 已记录所有bug和改进建议

**下一步**：
1. 将测试结果反馈给开发团队
2. 如有bug，提交issue并附上截图
3. 如通过测试，准备集成AdMob SDK
4. 开始Week 2-4的功能开发（创作者激励）

---

## 📞 获取帮助

**遇到问题？**
1. 查看上面的"常见问题排查"
2. 查看`[完成]第一阶段核心功能实施报告.md`
3. 查看`产品未来规划.md`
4. 检查控制台错误信息

**测试愉快！** 🎉
